<VirtualHost *:80>
    ServerName localhost
    SecRuleEngine On
    ProxyPreserveHost On

    # 1. Agregamos persistencia (Sticky Sessions) para no perder la sesión
    Header add Set-Cookie "ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/" env=BALANCER_ROUTE_CHANGED

    # 2. Metemos a S4 dentro del clúster para que comparta el flujo de navegación
    <Proxy "balancer://extragram_cluster">
        BalancerMember "http://s2-app:80" route=1
        BalancerMember "http://s3-app:80" route=2
        BalancerMember "http://s4-upload:80" route=3
        # Usamos stickysession para que si entras por S2, te quedes en S2 (o S4)
        ProxySet stickysession=ROUTEID
    </Proxy>

    # --- REGLAS DE ENRUTAMIENTO ---

    # Imágenes (S5)
    ProxyPass        "/uploads/" "http://s5-images/imatges_grup1/"
    ProxyPassReverse "/uploads/" "http://s5-images/imatges_grup1/"

    # Estáticos (S6)
    ProxyPass        "/static/" "http://s6-static:80/"
    ProxyPassReverse "/static/" "http://s6-static:80/"

    # TODO lo demás (incluido /upload.php) al Clúster
    # Al estar S4 dentro del clúster, ya no hace falta una regla específica para él
    ProxyPass        "/" "balancer://extragram_cluster/"
    ProxyPassReverse "/" "balancer://extragram_cluster/"

    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
