services:
  # --- CAPA DE ENTRADA ---
  s1-proxy:
    build: ./Balancer
    container_name: s1-proxy
    ports:
      - "80:80"
    volumes:
      - ./Balancer/balancer.conf:/usr/local/apache2/conf/extra/balancer.conf
    depends_on:
      - s2-app
      - s3-app
    networks:
      - extagram-net

  # --- CAPA DE APLICACIÃ“N (Nodos) ---
  s2-app: &node_base
    build: ./Nodes
    environment:
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
    volumes:
      - ./html:/var/www/html
      - uploads-shared:/var/www/html/uploads
    networks:
      - extagram-net

  s3-app:
    <<: *node_base
    container_name: s3-app

  s4-upload:
    <<: *node_base
    container_name: s4-upload

  # --- CAPA DE CONTENIDO ---
  s5-images:
    image: httpd:2.4
    container_name: s5-images
    volumes:
      - uploads-shared:/usr/local/apache2/htdocs/uploads:ro
    networks:
      - extagram-net

  s6-static:
    image: httpd:2.4
    container_name: s6-static
    volumes:
      - ./html:/usr/local/apache2/htdocs:ro
    networks:
      - extagram-net

  # --- CAPA DE DATOS ---
  s7-db:
    image: mariadb:10.6
    container_name: s7_database
    env_file: .env
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - ./data/db:/var/lib/mysql
      - ./BBDD/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - extagram-net

volumes:
  uploads-shared:

networks:
  extagram-net:
    driver: bridge
